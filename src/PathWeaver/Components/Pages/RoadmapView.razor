@page "/roadmap"
@rendermode InteractiveServer
@inject PathWeaver.Services.RoadmapService RoadmapService
@using PathWeaver.Models
@using System.Linq

<PageTitle>PathWeaver - Your Learning Roadmap</PageTitle>

<div class="container mt-4">
    @if (roadmap == null)
    {
        <div class="alert alert-warning" role="alert">
            <h4 class="alert-heading">No roadmap available!</h4>
            <p>It looks like you haven't created a roadmap yet. Please go back to the <a href="/" class="alert-link">home page</a> to start building your learning roadmap.</p>
        </div>
    }
    else
    {
        <div class="card shadow-sm mb-3">
            <div class="card-body">
                <h5 class="card-title">Learning Goal: @roadmap.UserProfile?.LearningGoal</h5>
                <p class="card-text">Status: @roadmap.Status</p>
                
                @if (!isSuggestingChanges)
                {
                    <button @onclick="() => isSuggestingChanges = true" class="btn btn-sm btn-outline-primary me-2">Suggest Changes</button>
                    <button class="btn btn-sm btn-outline-secondary">Save/Export</button>
                }

                @if (isSuggestingChanges)
                {
                    <div class="mt-3">
                        <h6>What changes would you like to suggest?</h6>
                        <textarea @bind="userSuggestion" class="form-control" rows="3" placeholder="e.g., 'Add more about React Hooks' or 'Remove CSS Grid'"></textarea>
                        <button @onclick="SendRefinementRequest" class="btn btn-sm btn-success mt-2" disabled="@isRefining">
                            @if (isRefining)
                            {
                                <span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>
                                <span class="sr-only">Sending...</span>
                                <span> Sending...</span>
                            }
                            else
                            {
                                <span>Send Feedback</span>
                            }
                        </button>
                        <button @onclick="() => isSuggestingChanges = false" class="btn btn-sm btn-light mt-2" disabled="@isRefining">Cancel</button>
                    </div>
                }

                @if (showRefinementMessage)
                {
                    <div class="alert alert-info mt-3" role="alert">
                        @refinementMessage
                    </div>
                }
            </div>
        </div>

        @foreach (var module in roadmap.Modules.OrderBy(m => m.Order))
        {
            <div class="accordion mb-2" id="@($"moduleAccordion{module.Order}")">
                <div class="accordion-item">
                    <h2 class="accordion-header" id="@($"heading{module.Order}")">
                        <button class="accordion-button @(module.Order == 1 ? "" : "collapsed")" type="button" data-bs-toggle="collapse" data-bs-target="@($"#collapse{module.Order}")" aria-expanded="@(module.Order == 1 ? "true" : "false")" aria-controls="@($"collapse{module.Order}")">
                            <span class="flex-grow-1">Module @module.Order: @module.Title</span>
                            <div class="progress me-3" style="width: 200px;">
                                <div class="progress-bar" role="progressbar" style="width: @module.AverageConfidence%;" aria-valuenow="@module.AverageConfidence" aria-valuemin="0" aria-valuemax="100">@module.AverageConfidence%</div>
                            </div>
                        </button>
                    </h2>
                    <div id="@($"collapse{module.Order}")" class="accordion-collapse collapse @(module.Order == 1 ? "show" : "")" aria-labelledby="@($"heading{module.Order}")" data-bs-parent="@($"#moduleAccordion{module.Order}")">
                        <div class="accordion-body">
                            <p>@module.Description</p>
                            <p class="text-muted">Estimated Time: @((int)module.EstimatedDuration.TotalMinutes) minutes</p>

                            <!-- Module Resources -->
                            @if (module.Resources.Any())
                            {
                                <div class="mb-4">
                                    <h6><strong>ðŸ“š Learning Resources for this Module:</strong></h6>
                                    <div class="row">
                                        @foreach (var resource in module.Resources)
                                        {
                                            <div class="col-md-6 mb-2">
                                                <div class="card bg-light border-primary">
                                                    <div class="card-body p-3">
                                                        <h6 class="card-title mb-1">
                                                            <a href="@resource.Url" target="_blank" class="text-decoration-none">
                                                                @resource.Title
                                                            </a>
                                                            <span class="badge bg-secondary ms-2">@resource.Type</span>
                                                        </h6>
                                                        <p class="card-text small text-muted mb-0">@resource.Description</p>
                                                    </div>
                                                </div>
                                            </div>
                                        }
                                    </div>
                                </div>
                            }

                            <!-- Module Topics -->
                            <h6><strong>ðŸ“– Topics to Learn:</strong></h6>

                            @foreach (var topic in module.Topics.OrderBy(t => t.Order))
                            {
                                <div class="card card-body bg-light mb-3 ms-3">
                                    <div class="d-flex justify-content-between align-items-center">
                                        <h6 class="card-title mb-0">Topic @topic.Order: @topic.Title</h6>
                                        <div>
                                            <span class="badge bg-info me-2">Confidence: @topic.ConfidenceScore%</span>
                                            <button @onclick="() => StartQuiz(topic)" class="btn btn-sm btn-secondary" disabled="@(isQuizzing.ContainsKey(topic) && isQuizzing[topic])">
                                                 @if (isQuizzing.ContainsKey(topic) && isQuizzing[topic])
                                                {
                                                    <span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>
                                                }
                                                else
                                                {
                                                    <span>Quiz Me</span>
                                                }
                                            </button>
                                        </div>
                                    </div>
                                    <p class="card-text mt-2">@topic.Description</p>
                                    
                                    @if (topic.Concepts.Any())
                                    {
                                        <div class="mt-3">
                                            <strong>Key Concepts to Learn:</strong>
                                            <ul class="list-group mt-2">
                                                @foreach (var concept in topic.Concepts.OrderBy(c => c.Order))
                                                {
                                                    <li class="list-group-item">
                                                        <div class="form-check">
                                                            <input class="form-check-input" type="checkbox" id="concept-@concept.GetHashCode()">
                                                            <label class="form-check-label" for="concept-@concept.GetHashCode()">
                                                                @concept.Title
                                                            </label>
                                                            <p class="text-muted small mb-0">@concept.Description</p>
                                                        </div>
                                                    </li>
                                                }
                                            </ul>
                                        </div>
                                    }


                                </div>
                            }
                        </div>
                    </div>
                </div>
            </div>
        }
    }
</div>

@code {
    private Roadmap? roadmap;
    private bool showRefinementMessage = false;
    private string refinementMessage = "";
    private bool isRefining = false;
    private bool isSuggestingChanges = false;
    private string userSuggestion = "";
    private Dictionary<RoadmapTopic, bool> isQuizzing = new();

    protected override void OnInitialized()
    {
        // Get roadmap from RoadmapService where agents store the data
        roadmap = RoadmapService.GetRoadMap();
    }
    
    private async Task StartQuiz(RoadmapTopic topic)
    {
        isQuizzing[topic] = true;
        await Task.Delay(2000); // Simulate quiz time
        topic.ConfidenceScore = new Random().Next(50, 101);
        isQuizzing[topic] = false;
        StateHasChanged();
    }

    private async Task SendRefinementRequest()
    {
        if (string.IsNullOrWhiteSpace(userSuggestion)) return;
        if (roadmap is null) return;

        isRefining = true;
        showRefinementMessage = true;
        refinementMessage = "Refinement Agent is processing your request...";
        await Task.Delay(2000); // Simulate agent thinking time

        // Mock agent logic (targets concepts for simplicity)
        if (userSuggestion.Contains("add", StringComparison.OrdinalIgnoreCase))
        {
            var newConceptName = $"New Concept based on '{userSuggestion}'";
            var firstTopic = roadmap.Modules.SelectMany(m => m.Topics).FirstOrDefault();
            if (firstTopic != null)
            {
                var newConcept = new RoadmapConcept
                {
                    Title = newConceptName,
                    Description = "This concept was added based on your feedback.",
                    Order = firstTopic.Concepts.Count + 1
                };
                firstTopic.Concepts.Add(newConcept);
                refinementMessage = $"Refinement Agent: I've added the concept '{newConceptName}' to the '{firstTopic.Title}' topic.";
            }
        }
        else if (userSuggestion.Contains("remove", StringComparison.OrdinalIgnoreCase))
        {
            var conceptToRemove = roadmap.Modules
                .SelectMany(m => m.Topics)
                .SelectMany(t => t.Concepts)
                .FirstOrDefault(c => c.Title != null && userSuggestion.Contains(c.Title, StringComparison.OrdinalIgnoreCase));
            
            if (conceptToRemove != null)
            {
                 foreach(var module in roadmap.Modules)
                {
                    foreach(var topic in module.Topics)
                    {
                        if (topic.Concepts.Contains(conceptToRemove))
                        {
                            topic.Concepts.Remove(conceptToRemove);
                            refinementMessage = $"Refinement Agent: I've removed the concept '{conceptToRemove.Title}'.";
                            break;
                        }
                    }
                }
            }
            else
            {
                refinementMessage = "Refinement Agent: I couldn't find a concept to remove based on your request.";
            }
        }
        else
        {
            refinementMessage = "Refinement Agent: Thank you for your feedback. I've noted your suggestion.";
        }

        isRefining = false;
        isSuggestingChanges = false;
        userSuggestion = "";
        StateHasChanged(); // Force UI update
    }
}
