@page "/roadmap"
@rendermode InteractiveServer
@inject PathWeaver.Services.RoadmapStateService RoadmapState
@using PathWeaver.Models
@using System.Linq
@implements IDisposable

<PageTitle>PathWeaver - Your Learning Roadmap</PageTitle>

<div class="container mt-4">
    @if (roadmap == null)
    {
        <p>Loading roadmap...</p>
    }
    else
    {
        <div class="card shadow-sm mb-3">
            <div class="card-body">
                <h5 class="card-title">Learning Goal: @roadmap.UserProfile?.LearningGoal</h5>
                <p class="card-text">Status: @roadmap.Status</p>
                
                @if (!isSuggestingChanges)
                {
                    <button @onclick="() => isSuggestingChanges = true" class="btn btn-sm btn-outline-primary me-2">Suggest Changes</button>
                    <button class="btn btn-sm btn-outline-secondary">Save/Export</button>
                }

                @if (isSuggestingChanges)
                {
                    <div class="mt-3">
                        <h6>What changes would you like to suggest?</h6>
                        <textarea @bind="userSuggestion" class="form-control" rows="3" placeholder="e.g., 'Add more about React Hooks' or 'Remove CSS Grid'"></textarea>
                        <button @onclick="SendRefinementRequest" class="btn btn-sm btn-success mt-2" disabled="@isRefining">
                            @if (isRefining)
                            {
                                <span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>
                                <span class="sr-only">Sending...</span>
                                <span> Sending...</span>
                            }
                            else
                            {
                                <span>Send Feedback</span>
                            }
                        </button>
                        <button @onclick="() => isSuggestingChanges = false" class="btn btn-sm btn-light mt-2" disabled="@isRefining">Cancel</button>
                    </div>
                }

                @if (showRefinementMessage)
                {
                    <div class="alert alert-info mt-3" role="alert">
                        @refinementMessage
                    </div>
                }
            </div>
        </div>

        @foreach (var module in roadmap.Modules.OrderBy(m => m.Order))
        {
            <div class="accordion mb-2" id="@($"moduleAccordion{module.Order}")">
                <div class="accordion-item">
                    <h2 class="accordion-header" id="@($"heading{module.Order}")">
                        <button class="accordion-button @(module.Order == 1 ? "" : "collapsed")" type="button" data-bs-toggle="collapse" data-bs-target="@($"#collapse{module.Order}")" aria-expanded="@(module.Order == 1 ? "true" : "false")" aria-controls="@($"collapse{module.Order}")">
                            <span class="flex-grow-1">Module @module.Order: @module.Title</span>
                            <div class="progress me-3" style="width: 200px;">
                                <div class="progress-bar" role="progressbar" style="width: @module.AverageConfidence%;" aria-valuenow="@module.AverageConfidence" aria-valuemin="0" aria-valuemax="100">@module.AverageConfidence%</div>
                            </div>
                        </button>
                    </h2>
                    <div id="@($"collapse{module.Order}")" class="accordion-collapse collapse @(module.Order == 1 ? "show" : "")" aria-labelledby="@($"heading{module.Order}")" data-bs-parent="@($"#moduleAccordion{module.Order}")">
                        <div class="accordion-body">
                            <p>@module.Description</p>
                            <p class="text-muted">Estimated Time: @module.EstimatedTimeMinutes minutes</p>

                            @foreach (var topic in module.Topics.OrderBy(t => t.Order))
                            {
                                <div class="card card-body bg-light mb-3 ms-3">
                                    <div class="d-flex justify-content-between align-items-center">
                                        <h6 class="card-title mb-0">Topic @topic.Order: @topic.Title</h6>
                                        <div>
                                            <span class="badge bg-info me-2">Confidence: @topic.ConfidenceScore%</span>
                                            <button @onclick="() => StartQuiz(topic)" class="btn btn-sm btn-secondary" disabled="@(isQuizzing.ContainsKey(topic) && isQuizzing[topic])">
                                                 @if (isQuizzing.ContainsKey(topic) && isQuizzing[topic])
                                                {
                                                    <span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>
                                                }
                                                else
                                                {
                                                    <span>Quiz Me</span>
                                                }
                                            </button>
                                        </div>
                                    </div>
                                    <p class="card-text mt-2">@topic.Description</p>
                                    
                                    @if (topic.Concepts.Any())
                                    {
                                        <div class="mt-3">
                                            <strong>Key Concepts to Learn:</strong>
                                            <ul class="list-group mt-2">
                                                @foreach (var concept in topic.Concepts.OrderBy(c => c.Order))
                                                {
                                                    <li class="list-group-item">
                                                        <div class="form-check">
                                                            <input class="form-check-input" type="checkbox" id="concept-@concept.GetHashCode()">
                                                            <label class="form-check-label" for="concept-@concept.GetHashCode()">
                                                                @concept.Title
                                                            </label>
                                                            <p class="text-muted small mb-0">@concept.Description</p>
                                                        </div>
                                                    </li>
                                                }
                                            </ul>
                                        </div>
                                    }

                                    @if (topic.Resources.Any())
                                    {
                                        <div class="mt-3">
                                            <strong>Recommended Resources:</strong>
                                            <ul class="list-group list-group-flush mt-2">
                                                @foreach (var resource in topic.Resources)
                                                {
                                                    <li class="list-group-item bg-light">
                                                        <a href="@resource.Url" target="_blank">@resource.Title</a> (@resource.Type)
                                                        <p class="text-muted small mb-0">@resource.Description</p>
                                                    </li>
                                                }
                                            </ul>
                                        </div>
                                    }
                                </div>
                            }
                        </div>
                    </div>
                </div>
            </div>
        }
    }
</div>

@code {
    private Roadmap? roadmap;
    private bool showRefinementMessage = false;
    private string refinementMessage = "";
    private bool isRefining = false;
    private bool isSuggestingChanges = false;
    private string userSuggestion = "";
    private Dictionary<RoadmapTopic, bool> isQuizzing = new();

    protected override void OnInitialized()
    {
        // Get roadmap from state service
        roadmap = RoadmapState.CurrentRoadmap;
        
        // If no roadmap is available, generate mock data for now
        if (roadmap == null)
        {
            roadmap = GenerateMockRoadmap();
        }
        
        // Subscribe to roadmap changes
        RoadmapState.RoadmapChanged += OnRoadmapChanged;
    }
    
    private void OnRoadmapChanged()
    {
        roadmap = RoadmapState.CurrentRoadmap;
        InvokeAsync(StateHasChanged);
    }
    
    public void Dispose()
    {
        RoadmapState.RoadmapChanged -= OnRoadmapChanged;
    }
    
    private async Task StartQuiz(RoadmapTopic topic)
    {
        isQuizzing[topic] = true;
        await Task.Delay(2000); // Simulate quiz time
        topic.ConfidenceScore = new Random().Next(50, 101);
        isQuizzing[topic] = false;
        StateHasChanged();
    }

    private async Task SendRefinementRequest()
    {
        if (string.IsNullOrWhiteSpace(userSuggestion)) return;
        if (roadmap is null) return;

        isRefining = true;
        showRefinementMessage = true;
        refinementMessage = "Refinement Agent is processing your request...";
        await Task.Delay(2000); // Simulate agent thinking time

        // Mock agent logic (targets concepts for simplicity)
        if (userSuggestion.Contains("add", StringComparison.OrdinalIgnoreCase))
        {
            var newConceptName = $"New Concept based on '{userSuggestion}'";
            var firstTopic = roadmap.Modules.SelectMany(m => m.Topics).FirstOrDefault();
            if (firstTopic != null)
            {
                var newConcept = new RoadmapConcept
                {
                    Title = newConceptName,
                    Description = "This concept was added based on your feedback.",
                    Order = firstTopic.Concepts.Count + 1
                };
                firstTopic.Concepts.Add(newConcept);
                refinementMessage = $"Refinement Agent: I've added the concept '{newConceptName}' to the '{firstTopic.Title}' topic.";
            }
        }
        else if (userSuggestion.Contains("remove", StringComparison.OrdinalIgnoreCase))
        {
            var conceptToRemove = roadmap.Modules
                .SelectMany(m => m.Topics)
                .SelectMany(t => t.Concepts)
                .FirstOrDefault(c => c.Title != null && userSuggestion.Contains(c.Title, StringComparison.OrdinalIgnoreCase));
            
            if (conceptToRemove != null)
            {
                 foreach(var module in roadmap.Modules)
                {
                    foreach(var topic in module.Topics)
                    {
                        if (topic.Concepts.Contains(conceptToRemove))
                        {
                            topic.Concepts.Remove(conceptToRemove);
                            refinementMessage = $"Refinement Agent: I've removed the concept '{conceptToRemove.Title}'.";
                            break;
                        }
                    }
                }
            }
            else
            {
                refinementMessage = "Refinement Agent: I couldn't find a concept to remove based on your request.";
            }
        }
        else
        {
            refinementMessage = "Refinement Agent: Thank you for your feedback. I've noted your suggestion.";
        }

        isRefining = false;
        isSuggestingChanges = false;
        userSuggestion = "";
        StateHasChanged(); // Force UI update
    }

    private Roadmap GenerateMockRoadmap()
    {
        var userProfile = new UserProfile
        {
            LearningGoal = "Become a full-stack web developer with C#/.NET and React",
            KnownSkills = new List<string?> { "Basic HTML", "Basic CSS" },
            PreferredLearningStyles = new List<string?> { "hands-on", "project-based" },
            ExperienceLevel = "intermediate"
        };

        var roadmap = new Roadmap
        {
            Id = Guid.NewGuid(),
            UserProfile = userProfile,
            CreatedDate = DateTime.Now,
            LastModifiedDate = DateTime.Now,
            Status = RoadmapStatus.Draft
        };

        // Module 1: Frontend Fundamentals
        var module1 = new RoadmapModule
        {
            Title = "Frontend Fundamentals",
            Description = "Learn the core technologies for building interactive user interfaces on the web.",
            Order = 1,
            EstimatedTimeMinutes = 900 // 15 hours
        };
        
        var topic1_1 = new RoadmapTopic
        {
            Title = "Advanced HTML5 & CSS3",
            Description = "Deep dive into semantic HTML, accessibility, responsive design, and modern CSS techniques.",
            Order = 1,
            Concepts = new List<RoadmapConcept>
            {
                new RoadmapConcept { Title = "Semantic HTML", Description = "Understand and use tags like <article>, <section>, and <nav>.", Order = 1},
                new RoadmapConcept { Title = "CSS Flexbox", Description = "Learn one-dimensional layouts.", Order = 2},
                new RoadmapConcept { Title = "CSS Grid", Description = "Learn two-dimensional layouts.", Order = 3}
            },
            Resources = new List<LearningResource>
            {
                new LearningResource { Title = "MDN Web Docs: HTML", Url = "https://developer.mozilla.org/en-US/docs/Web/HTML", Type = ResourceType.Documentation, Source = "MDN", Description = "Comprehensive HTML reference." },
                new LearningResource { Title = "Flexbox Froggy", Url = "https://flexboxfroggy.com/", Type = ResourceType.Game, Source = "PlayCanvas", Description = "Interactive game to learn Flexbox." },
                new LearningResource { Title = "CSS Grid Garden", Url = "https://cssgridgarden.com/", Type = ResourceType.Game, Source = "PlayCanvas", Description = "Interactive game to learn CSS Grid." }
            }
        };
        module1.Topics.Add(topic1_1);

        var topic1_2 = new RoadmapTopic
        {
            Title = "JavaScript Core Concepts",
            Description = "Master variables, data types, functions, control flow, DOM manipulation, and asynchronous JavaScript.",
            Order = 2,
            Concepts = new List<RoadmapConcept>
            {
                new RoadmapConcept { Title = "Variables, Data Types, and Operators", Description = "The fundamentals of storing and manipulating data.", Order = 1 },
                new RoadmapConcept { Title = "Functions and Scope", Description = "Learn to write and use functions.", Order = 2 },
                new RoadmapConcept { Title = "DOM Manipulation", Description = "Change the structure and content of a web page.", Order = 3 },
                new RoadmapConcept { Title = "Asynchronous JavaScript", Description = "Understand Promises and async/await.", Order = 4 }
            },
            Resources = new List<LearningResource>
            {
                new LearningResource { Title = "JavaScript.info - The Modern JavaScript Tutorial", Url = "https://javascript.info/", Type = ResourceType.Tutorial, Source = "Ilya Kantor", Description = "The definitive modern JS tutorial." },
                new LearningResource { Title = "Eloquent JavaScript", Url = "https://eloquentjavascript.net/", Type = ResourceType.Book, Source = "Marijn Haverbeke", Description = "A comprehensive book on JavaScript." }
            }
        };
        module1.Topics.Add(topic1_2);
        roadmap.Modules.Add(module1);

        return roadmap;
    }
}
